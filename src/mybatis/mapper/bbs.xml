<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bbs">

<!-- Main 태희 -->
	<!-- 해외여행 최신 게시글 5개 조회 -->
	<select id="load_overseas" resultType="mybatis.vo.BbsVO">
		<![CDATA[		
		select * 
		from (select * from bbs_t
      		order by write_date desc)
		where rownum <= 5
		]]>
	</select>
	
	<!-- 해외여행 인기 게시글 1개 조회 -->
	<select id="load_overseas_best" resultType="mybatis.vo.BbsVO">
		<![CDATA[	
		select * 
		from (select * from bbs_t
      		order by write_date DESC)
		where rownum = 1
		]]>
	</select>
	
<!-- registry 나영 -->
	<!-- 회원가입시 회원 아이디 중복검사 -->
	<select id="get_member" parameterType="String" resultType="mybatis.vo.MemVO">
		select * from member_t
		where m_id = #{id}
	</select>

	<!-- 회원 추가  -->
	<insert id="add_member" parameterType="java.util.Map">
	 INSERT INTO member_t(m_id, m_pw, m_name, m_email, m_phone, reg_date) 
	 VALUES(#{id}, #{pw}, #{name}, #{email}, #{phone}, sysdate)
	</insert>

<!-- Login 도현 -->
	<!-- id, pw받아서 login기능 -->
	<select id="login_member" parameterType="java.util.Map"
	resultType="mybatis.vo.MemVO">
		SELECT * FROM member_t
		WHERE m_id = #{id} AND m_pw = #{pw}
	</select>
	
<!-- List 은경 -->
	<!-- 전체 게시물 수 반환기능 -->
	<select id="get_totalCount" resultType="int">
		SELECT COUNT(*) FROM bbs_t
		WHERE status = 0
	</select>
	
	<!-- list의 해당 페이지의 게시물을 불러오는 기능 -->
	<select id="get_list" parameterType="java.util.Map"
	resultMap="map1">
		SELECT * FROM(
			SELECT rownum r_num, a.* FROM(
				SELECT * FROM bbs_t
				WHERE status = 0
				ORDER BY b_idx DESC
			) a
		) WHERE r_num BETWEEN #{begin} AND #{end}
	
	</select>

	<!-- bbsList의 resultMap -->
	<resultMap type="mybatis.vo.BbsVO" id="map1">
		<id property="b_idx" column="b_idx"/>
		<collection property="c_list" ofType="mybatis.vo.CommVO"
			column="b_idx" select="get_commList"/>
	</resultMap>

	<!-- 특정 게시글의 댓글 리스트 반환 -->
	<select id="get_commList" resultType="mybatis.vo.CommVO"
	parameterType="String">
		SELECT * FROM comment_t
		WHERE b_idx = #{b_idx}
	</select>
	
	<!-- 댓글 추가 -->
	<insert id="write_comm">
		insert into comment_t(c_idx, writer, content, pwd, write_date, ip, b_idx)
		values(comment_t_seq.NEXTVAL, #{writer}, #{content}, #{pwd}, sysdate, #{ip}, #{b_idx})
	</insert>

	<!-- 조회수 증가 -->
	<update id="add_hit" parameterType="String">
		UPDATE bbs_t
		SET hit = hit+1
		WHERE b_idx = #{no}
	</update>
	
	<!-- 게시글 조회 -->
	<select id="get_bbs" parameterType="String" 
	resultMap="map1">
		SELECT * FROM bbs_t
		WHERE b_idx = #{no}
	</select>
	
	<!-- 원글 저장 -->
	<insert id="write_bbs" parameterType="java.util.Map">
		INSERT INTO bbs_t(b_idx, subject, writer, content,
			pwd, write_date, file_name, ori_name, ip, hit, status)
		VALUES(bbs_t_seq.NEXTVAL, #{title},#{writer},#{content},'1111',
			 sysdate, #{fname}, #{oname}, #{ip}, 0, 0)
	</insert>
	
	<!-- 원글 수정 -->
	<update id="edit_bbs" parameterType="java.util.Map">
		UPDATE bbs_t
		SET
			subject = #{subject},
			content = #{content}
			<if test="fname != null">
				,file_name = #{fname}
				,ori_name = #{oname}
			</if>
		WHERE b_idx = #{b_idx} AND pwd = #{pwd}
	</update>
	
</mapper>






